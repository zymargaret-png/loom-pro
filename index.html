<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loom Pro å…¨åŠŸèƒ½ç‰ˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body {
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
      color: #1e293b;
    }
    h1 {
      margin: 20px 0;
      font-size: 24px;
      text-align: center;
    }
    .section {
      margin: 15px 0;
      width: 100%;
      max-width: 600px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
    }
    select, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 16px;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn-group button {
      flex: 1;
      min-width: 120px;
    }
    #recordBtn { background: #ef4444; color: white; }
    #stopBtn { background: #94a3b8; color: white; display: none; }
    #preview, #pipVideo {
      display: none;
      margin-top: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #pipVideo {
      position: absolute;
      width: 120px;
      height: auto;
      bottom: 20px;
      right: 20px;
      border: 2px solid white;
      border-radius: 8px;
      z-index: 10;
    }
    .status {
      margin-top: 10px;
      color: #64748b;
      text-align: center;
      min-height: 20px;
    }
    canvas {
      display: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ¥ Loom Pro å…¨åŠŸèƒ½ç‰ˆï¼ˆå½•å±+æ‘„åƒå¤´+ç¾é¢œï¼‰</h1>

  <div class="section">
    <label for="aspect">ğŸ“¹ è§†é¢‘æ¯”ä¾‹</label>
    <select id="aspect">
      <option value="16:9">16:9ï¼ˆå®½å±ï¼‰</option>
      <option value="9:16">9:16ï¼ˆæŠ–éŸ³ç«–å±ï¼‰</option>
      <option value="3:4">3:4ï¼ˆå°çº¢ä¹¦ï¼‰</option>
      <option value="1:1">1:1ï¼ˆæ–¹å½¢ï¼‰</option>
    </select>
  </div>

  <div class="section">
    <label>ğŸ¤ éŸ³é¢‘ä¸æ‘„åƒå¤´</label>
    <div class="btn-group">
      <button id="startBtn">â–¶ï¸ å¼€å§‹å½•åˆ¶</button>
      <button id="stopBtn">â¹ åœæ­¢å¹¶ä¸‹è½½</button>
    </div>
  </div>

  <div class="status" id="status">ç‚¹å‡»â€œå¼€å§‹å½•åˆ¶â€ä»¥å…±äº«å±å¹•å’Œéº¦å…‹é£</div>

  <video id="preview" autoplay muted playsinline></video>
  <video id="pipVideo" autoplay muted playsinline></video>
  <canvas id="filterCanvas"></canvas>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const preview = document.getElementById('preview');
    const pipVideo = document.getElementById('pipVideo');
    const statusEl = document.getElementById('status');
    const aspectSelect = document.getElementById('aspect');
    const canvas = document.getElementById('filterCanvas');
    const ctx = canvas.getContext('2d');

    let screenStream = null;
    let micStream = null;
    let cameraStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let animationFrameId = null;

    // ç¾é¢œå‚æ•°ï¼ˆå¯è°ƒï¼‰
    const beautyConfig = {
      brightness: 1.1,
      contrast: 1.05
    };

    // è·å–æ‘„åƒå¤´
    async function getCamera() {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        pipVideo.srcObject = cameraStream;
        pipVideo.style.display = 'block';
        return cameraStream;
      } catch (err) {
        console.warn('æ‘„åƒå¤´ä¸å¯ç”¨:', err);
        pipVideo.style.display = 'none';
        return null;
      }
    }

    // ç»˜åˆ¶å¸¦ç¾é¢œçš„æ··åˆç”»é¢ï¼ˆå½•å± + æ‘„åƒå¤´ï¼‰
    function drawCombinedFrame(screenVideo, camVideo) {
      if (!screenVideo.videoWidth || !camVideo?.videoWidth) return;

      const ratio = aspectSelect.value;
      let [w, h] = ratio.split(':').map(Number);
      if (!w || !h) { w = 16; h = 9; }

      // è®¾ç½® canvas å°ºå¯¸
      canvas.width = w * 60; // ä¾‹å¦‚ 16*60=960
      canvas.height = h * 60; // 9*60=540

      // æ¸…ç©ºå¹¶ç»˜åˆ¶å½•å±ç”»é¢ï¼ˆç¼©æ”¾å¡«å……ï¼‰
      ctx.filter = `brightness(${beautyConfig.brightness}) contrast(${beautyConfig.contrast})`;
      ctx.drawImage(screenVideo, 0, 0, canvas.width, canvas.height);

      // åœ¨å³ä¸‹è§’ç»˜åˆ¶æ‘„åƒå¤´ï¼ˆå°çª—å£ï¼‰
      if (camVideo && camVideo.readyState >= 2) {
        const camSize = Math.min(canvas.width, canvas.height) * 0.25;
        ctx.filter = 'none'; // æ‘„åƒå¤´ä¸åŠ ç¾é¢œï¼ˆå¯é€‰ï¼‰
        ctx.drawImage(camVideo, canvas.width - camSize - 10, canvas.height - camSize - 10, camSize, camSize);
      }

      ctx.filter = 'none';
    }

    // å¼€å§‹å½•åˆ¶
    async function startRecording() {
      try {
        statusEl.textContent = 'è¯·æ±‚å±å¹•å…±äº«...';
        startBtn.disabled = true;

        // è·å–å±å¹• + éº¦å…‹é£
        screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: { cursor: "motion" },
          audio: true // å¯ç”¨éº¦å…‹é£
        });

        micStream = screenStream; // éŸ³é¢‘å·²åŒ…å«åœ¨ screenStream ä¸­ï¼ˆéƒ¨åˆ†æµè§ˆå™¨ï¼‰

        // è·å–æ‘„åƒå¤´
        await getCamera();

        // æ˜¾ç¤ºé¢„è§ˆ
        preview.srcObject = screenStream;
        preview.style.display = 'block';

        // åˆ›å»ºç¦»å± canvas æµï¼ˆç”¨äºå½•åˆ¶æ··åˆç”»é¢ï¼‰
        const captureStream = canvas.captureStream(30); // 30fps

        // å¼€å§‹å½•åˆ¶ canvas æµ
        mediaRecorder = new MediaRecorder(captureStream, { mimeType: 'video/webm;codecs=vp9' });
        recordedChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `LoomPro_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.webm`;
          a.click();
          URL.revokeObjectURL(url);
          cleanup();
          statusEl.textContent = 'âœ… è§†é¢‘å·²ä¸‹è½½ï¼';
        };

        mediaRecorder.start();

        // å¼€å§‹ç»˜åˆ¶æ··åˆç”»é¢
        function animate() {
          drawCombinedFrame(preview, pipVideo);
          animationFrameId = requestAnimationFrame(animate);
        }
        animate();

        // åˆ‡æ¢æŒ‰é’®
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        statusEl.textContent = 'ğŸ”´ æ­£åœ¨å½•åˆ¶... ç‚¹å‡»â€œåœæ­¢â€ä¿å­˜è§†é¢‘';

      } catch (err) {
        console.error('å¯åŠ¨å¤±è´¥:', err);
        statusEl.textContent = `âŒ é”™è¯¯: ${err.message || 'ç”¨æˆ·å–æ¶ˆæˆ–æƒé™è¢«æ‹’'}`;
        startBtn.disabled = false;
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        cancelAnimationFrame(animationFrameId);
      }
    }

    function cleanup() {
      [screenStream, micStream, cameraStream].forEach(stream => {
        if (stream) stream.getTracks().forEach(track => track.stop());
      });
      preview.srcObject = null;
      pipVideo.srcObject = null;
      preview.style.display = 'none';
      pipVideo.style.display = 'none';
      startBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      startBtn.disabled = false;
    }

    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
  </script>
</body>
</html>